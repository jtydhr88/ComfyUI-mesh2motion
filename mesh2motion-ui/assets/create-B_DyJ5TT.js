import{G as f,a as c,b as M,M as y}from"./dialog-uPTpjSkG.js";class p{constructor(){this.engine=null,this.isComfyUIMode=!1,this.parentOrigin="*",this.gltfLoader=new f,this.isComfyUIMode=this.detectComfyUIMode(),this.isComfyUIMode&&this.setupMessageListener()}detectComfyUIMode(){return new URLSearchParams(window.location.search).get("comfyui")==="true"}isInComfyUIMode(){return this.isComfyUIMode}setEngine(e){console.log("[Mesh2Motion ComfyUI Integration] setEngine called, isComfyUIMode:",this.isComfyUIMode),this.engine=e,this.sendReadyMessage()}setupMessageListener(){window.addEventListener("message",e=>{this.handleMessage(e)})}handleMessage(e){const o=e.data;if(!(!o||typeof o.type!="string"))switch(console.log("[Mesh2Motion ComfyUI Integration] Received message:",o.type,o.data),o.type){case"comfyui:loadModel":this.handleLoadModel(o.data);break;case"comfyui:requestExport":this.handleExportRequest();break;case"comfyui:setTheme":this.handleSetTheme(o.data);break;default:console.log("[Mesh2Motion] Unknown message type:",o.type)}}sendMessage(e,o){!window.parent||window.parent===window||window.parent.postMessage({type:e,data:o},this.parentOrigin)}sendReadyMessage(){this.sendMessage("mesh2motion:ready")}async handleLoadModel(e){if(console.log("[Mesh2Motion ComfyUI Integration] handleLoadModel called with:",e),!e?.url||!this.engine){console.error("[Mesh2Motion ComfyUI Integration] Invalid model URL or engine not initialized",{url:e?.url,engine:!!this.engine}),this.sendMessage("mesh2motion:error",{message:"Invalid model URL or engine not initialized"});return}try{console.log("[Mesh2Motion ComfyUI Integration] Fetching model from:",e.url);const o=await fetch(e.url);if(!o.ok)throw new Error(`Failed to fetch model: ${o.statusText}`);const t=await o.arrayBuffer();console.log("[Mesh2Motion ComfyUI Integration] Model fetched, size:",t.byteLength);const s=e.url.toLowerCase();let n="glb";s.includes(".gltf")?n="gltf":s.includes(".fbx")&&(n="fbx"),console.log("[Mesh2Motion ComfyUI Integration] Detected file extension:",n);const i=this.arrayBufferToDataUrl(t,n);console.log("[Mesh2Motion ComfyUI Integration] Loading model into engine..."),this.engine.load_model_step.load_model_file(i,n),this.sendMessage("mesh2motion:modelLoaded")}catch(o){console.error("[Mesh2Motion ComfyUI Integration] Failed to load model:",o),this.sendMessage("mesh2motion:error",{message:o instanceof Error?o.message:"Failed to load model"})}}arrayBufferToDataUrl(e,o){const s={glb:"model/gltf-binary",gltf:"model/gltf+json",fbx:"application/octet-stream"}[o]||"application/octet-stream",n=new Uint8Array(e);let i="";for(let l=0;l<n.byteLength;l++)i+=String.fromCharCode(n[l]);const d=btoa(i);return`data:${s};base64,${d}`}async handleExportRequest(){if(!this.engine){this.sendMessage("mesh2motion:error",{message:"Engine not initialized"});return}try{const e=this.engine.weight_skin_step?.final_skinned_meshes(),o=this.engine.animations_listing_step?.get_selected_animation_clips?.()||[];if(!e||e.length===0){this.sendMessage("mesh2motion:error",{message:"No skinned meshes to export"});return}const t=await this.exportToGLB(e,o),s=`mesh2motion-${Date.now()}.glb`;this.sendMessage("mesh2motion:export",{modelData:t,filename:s})}catch(e){console.error("[Mesh2Motion] Export failed:",e),this.sendMessage("mesh2motion:error",{message:e instanceof Error?e.message:"Export failed"})}}exportToGLB(e,o){return new Promise((t,s)=>{const n=new c,i=new Map;e.forEach(r=>{i.set(r,r.parent),n.add(r)});const d=new M,l={binary:!0,onlyVisible:!1,embedImages:!0,animations:o};d.parse(n,r=>{e.forEach(a=>{const m=i.get(a);m?m.add(a):n.remove(a)}),t(r)},r=>{e.forEach(a=>{const m=i.get(a);m&&m.add(a)}),s(r)},l)})}handleSetTheme(e){!this.engine||!e?.theme||(this.engine.theme_manager.set_theme(e.theme),this.engine.regenerate_floor_grid())}exportToComfyUI(e,o){if(!this.isComfyUIMode){console.warn("[Mesh2Motion] Not in ComfyUI mode, cannot export to ComfyUI");return}this.exportToGLB(e,o).then(t=>{const s=`mesh2motion-${Date.now()}.glb`;this.sendMessage("mesh2motion:export",{modelData:t,filename:s})}).catch(t=>{console.error("[Mesh2Motion] Export to ComfyUI failed:",t),this.sendMessage("mesh2motion:error",{message:t instanceof Error?t.message:"Export failed"})})}}let g=null;function u(){return g||(g=new p),g}class I{constructor(){this.mesh2motion_engine=new y,u().setEngine(this.mesh2motion_engine)}}new I;
