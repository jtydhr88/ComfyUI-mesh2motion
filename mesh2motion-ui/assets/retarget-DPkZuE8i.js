import{G as D,a as H,S as d,r as f,b as B,c as v,B as R,V as g,Q as C,d as T,A as I,E as N,e as b,f as y,O as x,h as P,i as $,j as O,k as q,l as U,M as W}from"./dialog-Bm5BuMR_.js";class j extends EventTarget{constructor(e){super(),this.loader=new D,this.loaded_source_armature=new H,this.skeleton_helper=null,this._added_event_listeners=!1,this.skeleton_type=d.None,this.skeleton_type_select=null,this._main_scene=e}begin(){this.skeleton_type_select=document.getElementById("skeleton-type-select"),this._added_event_listeners||(this.add_event_listeners(),this._added_event_listeners=!0),this.load_default_skeleton()}load_default_skeleton(){this.skeleton_type=d.Human,this.load_skeleton_from_path(f(d.Human)).catch(e=>{console.error("Failed to load default human skeleton:",e)}),this.dispatchEvent(new CustomEvent("skeleton-loading"))}add_event_listeners(){this.skeleton_type_select?.addEventListener("change",()=>{this.handle_skeleton_selection_change()})}handle_skeleton_selection_change(){if(this.skeleton_type_select===null)return;const e=this.skeleton_type_select.value;this.skeleton_type=this.get_skeleton_type_enum(e),this.clear_previous_skeleton(),this.load_skeleton_from_path(f(this.skeleton_type)).catch(t=>{console.error("Failed to load skeleton:",t)}),this.dispatchEvent(new CustomEvent("skeleton-loading"))}get_skeleton_type_enum(e){switch(e){case"human":return d.Human;case"quadraped":return d.Quadraped;case"bird":return d.Bird;case"dragon":return d.Dragon;default:return d.None}}async load_skeleton_from_path(e){try{await new Promise((t,n)=>{this.loader.load(e,i=>{this.process_loaded_skeleton(i),t()},void 0,i=>{n(i)})})}catch(t){console.error("Error loading skeleton:",t),this.show_error_dialog("Error loading skeleton file.")}}process_loaded_skeleton(e){if(!this.is_skeleton_valid(e)){this.show_error_dialog("No bones found in skeleton file. Please select a valid skeleton.");return}this.loaded_source_armature=e.scene.clone(),this.loaded_source_armature.name="Source Skeleton Scene (Mesh2Motion)",this.loaded_source_armature.position.set(2.5,0,0),this.loaded_source_armature.updateWorldMatrix(!0,!0),console.log("Source skeleton (Mesh2Motion) loaded successfully:",this.loaded_source_armature),this.add_skeleton_and_helper_to_scene(),this.dispatchEvent(new CustomEvent("skeleton-loaded"))}is_skeleton_valid(e){let t=!1;return e.scene.traverse(n=>{n.type==="Bone"&&(t=!0)}),t}show_skeleton_helper(e){this.skeleton_helper!==null&&(this.skeleton_helper.visible=e)}add_skeleton_and_helper_to_scene(){this._main_scene.add(this.loaded_source_armature),this.skeleton_helper=new B(this.loaded_source_armature),this.skeleton_helper.name="Source Skeleton Helper (Mesh2Motion)",this._main_scene.add(this.skeleton_helper),console.log("Source skeleton added to scene with helper")}clear_previous_skeleton(){this.loaded_source_armature.parent!==null&&(this._main_scene.remove(this.loaded_source_armature),console.log("Removed previous source armature from scene")),this.skeleton_helper!==null&&this.skeleton_helper.parent!==null&&(this._main_scene.remove(this.skeleton_helper),console.log("Removed previous skeleton helper from scene"))}show_error_dialog(e){new v(e,"Error").show()}get_loaded_source_armature(){return this.loaded_source_armature}get_skeleton_type(){return this.skeleton_type}}class w{static reset_skinned_mesh_to_rest_pose(e){e.traverse(t=>{if(t.type==="SkinnedMesh"){const n=t;n.skeleton.pose(),n.updateMatrixWorld(!0)}})}static validate_skinned_mesh_has_bones(e){let t=!1;return e.traverse(n=>{n.type==="SkinnedMesh"&&(t=!0)}),t?(console.log("skinned meshes found. ready to start retargeting process:",t),!0):(new v("No SkinnedMeshes found in file","Error opening file").show(),!1)}static get_animation_file_path(e){switch(e){case d.Human:return f("animations/human-base-animations.glb");case d.Quadraped:return f("animations/quad-creature-animations.glb");case d.Bird:return f("animations/bird-animations.glb");case d.Dragon:return f("animations/dragon-animations.glb");default:return null}}static create_track_name(e,t){return`${e}.${t}`}}class G extends EventTarget{constructor(e){super(),this.file_input=null,this.load_model_button=null,this.retargetable_meshes=null,this.mesh2motion_engine=e}begin(){this.add_event_listeners()}get_retargetable_meshes(){return this.retargetable_meshes}add_event_listeners(){if(this.file_input=document.getElementById("upload-file"),this.load_model_button=document.getElementById("load-model-button"),this.file_input===null){console.error("Could not find file input element");return}this.file_input.addEventListener("change",e=>{console.log("File input changed",e),this.handle_file_select(e)})}handle_file_select(e){const t=e.target;if(t.files!==null&&t.files.length>0){const n=t.files[0];console.log("File selected:",n.name,"Size:",n.size,"Type:",n.type);const i=n.name.toLowerCase();let a="";if(i.endsWith(".glb"))a="glb";else if(i.endsWith(".fbx"))a="fbx";else if(i.endsWith(".zip"))a="zip";else{new v("Unsupported file type. Please select a GLB, FBX, or ZIP file.","Error").show();return}this.mesh2motion_engine.load_model_step.set_preserve_skinned_mesh(!0);const s=URL.createObjectURL(n);try{this.mesh2motion_engine.load_model_step.load_model_file(s,a),this.mesh2motion_engine.load_model_step.addEventListener("modelLoadedForRetargeting",()=>{console.log("Model loaded for retargeting successfully."),URL.revokeObjectURL(s);const o=this.mesh2motion_engine.load_model_step.get_final_retargetable_model_data();if(w.validate_skinned_mesh_has_bones(o)){console.log("adding retargetable meshes to scene for retargeting");const m=new R().setFromObject(o),_=new g;m.getSize(_),console.log("Retargetable meshes bounding box size:",_),console.log("Skinned mesh data to inspect:",o),w.reset_skinned_mesh_to_rest_pose(o),this.mesh2motion_engine.get_scene().add(o),this.calculate_max_mesh_dimension(o)>7&&(this.scale_skinned_meshes_to_fit_viewport(o,.99),this.move_skinned_meshes_to_ground(o)),this.add_skeleton_helper(o),this.retargetable_meshes=o,this.dispatchEvent(new CustomEvent("target-model-loaded"))}},{once:!0})}catch(o){console.error("Error loading model:",o),new v("Error loading model file.","Error").show(),URL.revokeObjectURL(s)}}}move_skinned_meshes_to_ground(e){e.traverse(t=>{t.type==="SkinnedMesh"&&console.log("current position for mesh: ",t.position)})}scale_skinned_meshes_to_fit_viewport(e,t){e.traverse(n=>{if(n.type==="SkinnedMesh"){const i=n;if(i.skeleton.bones.length>0){let s=i.skeleton.bones[0];for(;s.parent!=null&&s.parent.type==="Bone";)s=s.parent;s.scale.multiplyScalar(t),s.updateMatrixWorld(!0),i.skeleton.update()}}})}add_skeleton_helper(e){e.traverse(t=>{if(t.type==="SkinnedMesh"){const n=t;this.mesh2motion_engine.regenerate_skeleton_helper(n.skeleton,"Retarget Skeleton Helper")}})}calculate_max_mesh_dimension(e){const t=new R().setFromObject(e),n=new g;return t.getSize(n),Math.max(n.x,n.y,n.z)}adjust_camera_for_model(e){const t=new R().setFromObject(e),n=new g;t.getSize(n);const i=new g;t.getCenter(i);const a=Math.max(n.x,n.y,n.z);a>50&&(console.log("Model is very large. Removing fog to increase visibility: ",a),this.mesh2motion_engine.set_fog_enabled(!1));const s=a*2.5,o=new g(i.x,i.y+a*.3,i.z+s);this.mesh2motion_engine.set_camera_position(o),console.log("Adjusted camera for model:",{bounding_box_size:n,center:i,max_dimension:a,camera_distance:s,camera_position:o})}}class u{static map_torso_bones(e,t){if(e===null||t===null)return console.error("map_torso_bones(): No source or target bones found. This should not be reached."),new Map;const n=new Map;return console.log("DEVELOPING THE TORSO MAPPER"),console.log("Source Bones:",e),console.log("Target Bones:",t),this.perform_exact_name_matching(e,t,n),n}static map_arm_bones(e,t){const n=new Map;return this.perform_exact_name_matching(e,t,n),n}static map_hand_bones(e,t){const n=new Map;return this.perform_exact_name_matching(e,t,n),n}static map_leg_bones(e,t){const n=new Map;return this.perform_exact_name_matching(e,t,n),n}static map_wing_bones(e,t){const n=new Map;return this.perform_exact_name_matching(e,t,n),n}static map_tail_bones(e,t){const n=new Map;return this.perform_exact_name_matching(e,t,n),n}static map_unknown_bones(e,t){const n=new Map;return this.perform_exact_name_matching(e,t,n),n}static perform_exact_name_matching(e,t,n){for(const i of t)if(!n.has(i.name)){for(const a of e)if(a.name===i.name){n.set(i.name,a.name);break}}}}const M=class M{static is_target_valid_skeleton(e){return e.some(t=>t.toLowerCase().includes("mixamorig"))}static map_mixamo_bones(e,t){const n=new Map;console.log("=== MIXAMO DIRECT MAPPING ===");for(const i of e){const a=this.BONE_MAP[i.name];if(a){const s=t.find(o=>o.name===a);s&&(n.set(s.name,i.name),console.log(`Mapped: ${s.name} -> ${i.name}`))}}return console.log(`Mixamo mapping complete: ${n.size} bones mapped`),n}};M.BONE_MAP={"DEF-hips":"mixamorigHips","DEF-spine001":"mixamorigSpine","DEF-spine002":"mixamorigSpine1","DEF-spine003":"mixamorigSpine2","DEF-neck":"mixamorigNeck","DEF-head":"mixamorigHead","DEF-headtip":"mixamorigHeadTop_End","DEF-shoulderL":"mixamorigLeftShoulder","DEF-upper_armL":"mixamorigLeftArm","DEF-forearmL":"mixamorigLeftForeArm","DEF-handL":"mixamorigLeftHand","DEF-shoulderR":"mixamorigRightShoulder","DEF-upper_armR":"mixamorigRightArm","DEF-forearmR":"mixamorigRightForeArm","DEF-handR":"mixamorigRightHand","DEF-thighL":"mixamorigLeftUpLeg","DEF-shinL":"mixamorigLeftLeg","DEF-footL":"mixamorigLeftFoot","DEF-toeL":"mixamorigLeftToeBase","DEF-toe_tipL":"mixamorigLeftToe_End","DEF-thighR":"mixamorigRightUpLeg","DEF-shinR":"mixamorigRightLeg","DEF-footR":"mixamorigRightFoot","DEF-toeR":"mixamorigRightToeBase","DEF-toe_tipR":"mixamorigRightToe_End","DEF-thumb01L":"mixamorigLeftHandThumb1","DEF-thumb02L":"mixamorigLeftHandThumb2","DEF-thumb03L":"mixamorigLeftHandThumb3","DEF-thumb_04_tipL":"mixamorigLeftHandThumb4","DEF-f_index01L":"mixamorigLeftHandIndex1","DEF-f_index02L":"mixamorigLeftHandIndex2","DEF-f_index03L":"mixamorigLeftHandIndex3","DEF-f_index04_tipL":"mixamorigLeftHandIndex4","DEF-f_middle01L":"mixamorigLeftHandMiddle1","DEF-f_middle02L":"mixamorigLeftHandMiddle2","DEF-f_middle03L":"mixamorigLeftHandMiddle3","DEF-f_middle04_tipL":"mixamorigLeftHandMiddle4","DEF-f_ring01L":"mixamorigLeftHandRing1","DEF-f_ring02L":"mixamorigLeftHandRing2","DEF-f_ring03L":"mixamorigLeftHandRing3","DEF-f_ring04_tipL":"mixamorigLeftHandRing4","DEF-f_pinky01L":"mixamorigLeftHandPinky1","DEF-f_pinky02L":"mixamorigLeftHandPinky2","DEF-f_pinky03L":"mixamorigLeftHandPinky3","DEF-f_pinky04_tipL":"mixamorigLeftHandPinky4","DEF-thumb01R":"mixamorigRightHandThumb1","DEF-thumb02R":"mixamorigRightHandThumb2","DEF-thumb03R":"mixamorigRightHandThumb3","DEF-thumb04_tipR":"mixamorigRightHandThumb4","DEF-f_index01R":"mixamorigRightHandIndex1","DEF-f_index02R":"mixamorigRightHandIndex2","DEF-f_index03R":"mixamorigRightHandIndex3","DEF-f_index04_tipR":"mixamorigRightHandIndex4","DEF-f_middle01R":"mixamorigRightHandMiddle1","DEF-f_middle02R":"mixamorigRightHandMiddle2","DEF-f_middle03R":"mixamorigRightHandMiddle3","DEF-f_middle04_tipR":"mixamorigRightHandMiddle4","DEF-f_ring01R":"mixamorigRightHandRing1","DEF-f_ring02R":"mixamorigRightHandRing2","DEF-f_ring03R":"mixamorigRightHandRing3","DEF-f_ring04_tipR":"mixamorigRightHandRing4","DEF-f_pinky01R":"mixamorigRightHandPinky1","DEF-f_pinky02R":"mixamorigRightHandPinky2","DEF-f_pinky03R":"mixamorigRightHandPinky3","DEF-f_pinky04_tipR":"mixamorigRightHandPinky4"};let E=M;class Q{static auto_map_bones(e,t,n){let i=new Map;const a=this.extract_source_bone_parent_map(e),s=this.extract_target_bone_parent_map(t),o=this.create_all_bone_metadata(a),r=this.create_all_bone_metadata(s);if(console.log(`
=== FINAL BONE METADATA ===`),console.log("Source bones metadata:",o),console.log("Target bones metadata:",r),n===L.Mixamo)return console.log("Target skeleton appears to be a Mixamo rig, performing direct name mapping..."),i=E.map_mixamo_bones(o,r),i;const m=["torso","arms","hands","legs","wings","tail","unknown"];for(const _ of m){const p=o.filter(l=>l.category===_),h=r.filter(l=>l.category===_);switch(_){case"torso":{const l=u.map_torso_bones(p,h);i=new Map([...i,...l]);break}case"arms":{const l=u.map_arm_bones(p,h);i=new Map([...i,...l]);break}case"hands":{const l=u.map_hand_bones(p,h);i=new Map([...i,...l]);break}case"legs":{const l=u.map_leg_bones(p,h);i=new Map([...i,...l]);break}case"wings":{const l=u.map_wing_bones(p,h);i=new Map([...i,...l]);break}case"tail":{const l=u.map_tail_bones(p,h);i=new Map([...i,...l]);break}case"unknown":{const l=u.map_unknown_bones(p,h);i=new Map([...i,...l]);break}}}return console.log(`
=== Auto-mapped bones summary ===`),console.log("Final mappings:",i),i}static extract_source_bone_parent_map(e){const t=new Map;return e.traverse(n=>{if(n.type==="Bone"){const i=n,a=i.parent!=null&&i.parent.type==="Bone"?i.parent.name:null;t.set(i.name,a)}}),t}static extract_target_bone_parent_map(e){const t=new Map;return e.traverse(n=>{if(n.type==="SkinnedMesh"){const i=n;for(const a of i.skeleton.bones){const s=a.parent!=null&&a.parent.type==="Bone"?a.parent.name:null;t.set(a.name,s)}}}),t}static create_all_bone_metadata(e){const t=[];for(const[n,i]of e.entries()){const a=this.normalize_bone_name(n),s=this.detect_bone_side(n),o=this.detect_bone_category(a),r={name:n,normalized_name:a,side:s,category:o,parent_name:i};t.push(r)}return t}static normalize_bone_name(e){let t=e.toLowerCase();return t=t.replace(/\s+/g,""),t=t.replace(/_/g,""),t=t.replace(/^def-/g,""),t=t.replace(/^mixamorig/g,""),t=t.replace(/\.\d+$/g,""),t=t.replace(/l$/g,""),t=t.replace(/r$/g,""),t=t.replace(/\d+$/g,""),t}static detect_bone_side(e){const t=e.toLowerCase();return t.includes("left")||t.endsWith("l")?"left":t.includes("right")||t.endsWith("r")?"right":"center"}static detect_bone_category(e){return e.includes("spine")||e.includes("chest")||e.includes("neck")||e.includes("head")||e.includes("hips")?"torso":e.includes("shoulder")||e.includes("upperarm")||e.includes("forearm")||e.includes("hand")||e.includes("wrist")?"arms":e.includes("thumb")||e.includes("index")||e.includes("middle")||e.includes("ring")||e.includes("pinky")?"hands":e.includes("thigh")||e.includes("shin")||e.includes("knee")||e.includes("foot")||e.includes("toe")||e.includes("calf")?"legs":e.includes("wing")||e.includes("feather")||e.includes("pinion")?"wings":e.includes("tail")?"tail":"unknown"}}var L=(c=>(c.Mixamo="mixamo",c.Mesh2Motion="mesh2motion",c.Custom="custom",c.None="none",c))(L||{});class z extends EventTarget{constructor(e){super(),this.target_skeleton_data=null,this.target_mapping_template="none",this.source_armature=new H,this.source_skeleton_type=d.None,this.source_bones_list=null,this.target_bones_list=null,this.clear_mappings_button=null,this.auto_map_button=null,this.source_bone_count=null,this.target_bone_count=null,this.bone_mapping=new Map,this.has_added_event_listeners=!1,this._main_scene=e}begin(){this.source_bones_list=document.getElementById("source-bones-list"),this.target_bones_list=document.getElementById("target-bones-list"),this.clear_mappings_button=document.getElementById("clear-mappings-button"),this.auto_map_button=document.getElementById("auto-map-button"),this.source_bone_count=document.getElementById("source-bone-count"),this.target_bone_count=document.getElementById("target-bone-count"),this.add_event_listeners(),this.update_bone_lists(),this.update_clear_button_visibility(),this.update_auto_map_button_visibility()}add_event_listeners(){this.has_added_event_listeners||(this.clear_mappings_button?.addEventListener("click",()=>{this.clear_all_bone_mappings(),console.log("All bone mappings cleared")}),this.auto_map_button?.addEventListener("click",()=>{this.auto_map_bones()}),this.has_added_event_listeners=!0)}set_source_skeleton_data(e,t){this.source_armature=e,this.source_skeleton_type=t,this.update_source_bones_list(),this.update_auto_map_button_visibility()}set_target_skeleton_data(e){this.target_skeleton_data=e,console.log("Target skeleton data set in bone mapping:",this.target_skeleton_data),this.update_target_bones_list(),this.update_auto_map_button_visibility()}has_source_skeleton(){return this.source_armature!==null}has_target_skeleton(){return this.target_skeleton_data!==null}has_both_skeletons(){return this.has_source_skeleton()&&this.has_target_skeleton()}get_source_armature(){return this.source_armature}get_target_skeleton_data(){return this.target_skeleton_data}get_source_skeleton_type(){return this.source_skeleton_type}get_target_mapping_template(){return this.target_mapping_template}get_source_bone_names(){if(this.source_armature===null)return[];const e=[];return this.source_armature.traverse(t=>{t.type==="Bone"&&e.push(t.name)}),e.sort()}get_target_bone_names(){if(this.target_skeleton_data===null)return[];const e=new Set;return this.target_skeleton_data.traverse(t=>{t.type==="SkinnedMesh"&&t.skeleton.bones.forEach(a=>{e.add(a.name)})}),Array.from(e).sort()}update_bone_lists(){this.update_source_bones_list(),this.update_target_bones_list()}update_source_bones_list(){if(this.source_bones_list===null)return;const e=this.get_source_bone_names();if(this.source_bone_count!==null&&(this.source_bone_count.textContent=`(${e.length})`),e.length===0){this.source_bones_list.innerHTML="<em>No source skeleton loaded</em>";return}this.source_bones_list.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.textContent=t,n.className="bone-item bone-item-source",n.draggable=!0,n.dataset.boneName=t,n.addEventListener("dragstart",this.handle_drag_start.bind(this)),n.addEventListener("dragend",this.handle_drag_end.bind(this)),this.source_bones_list?.appendChild(n)})}update_target_bones_list(){if(this.target_bones_list===null)return;const e=this.get_target_bone_names();if(this.target_bone_count!==null&&(this.target_bone_count.textContent=`(${e.length})`),e.length===0){this.target_bones_list.innerHTML="<em>No target skeleton loaded</em>";return}this.target_bones_list.innerHTML="",e.forEach(t=>{const n=document.createElement("div");n.className="bone-item bone-item-target",n.dataset.targetBoneName=t;const i=this.bone_mapping.get(t);if(i!==void 0){const a=document.createElement("span");a.textContent=i,a.className="mapping-source-name";const s=document.createElement("span");s.textContent=t,n.appendChild(a),n.appendChild(s);const o=document.createElement("button");o.textContent="âœ•",o.className="remove-mapping-button secondary-button",o.title="Remove this mapping",o.addEventListener("click",r=>{r.stopPropagation(),this.clear_bone_mapping(t)}),n.appendChild(o)}else n.textContent=t;n.addEventListener("dragover",this.handle_drag_over.bind(this)),n.addEventListener("dragleave",this.handle_drag_leave.bind(this)),n.addEventListener("drop",this.handle_drop.bind(this)),this.target_bones_list?.appendChild(n)})}handle_drag_start(e){const t=e.target,n=t.dataset.boneName;n!==void 0&&e.dataTransfer!==null&&(e.dataTransfer.effectAllowed="copy",e.dataTransfer.setData("text/plain",n),t.classList.add("dragging"))}handle_drag_end(e){e.target.classList.remove("dragging")}handle_drag_over(e){e.preventDefault();const t=e.target;e.dataTransfer!==null&&(e.dataTransfer.dropEffect="copy"),t.classList.add("drag-over")}handle_drag_leave(e){e.target.classList.remove("drag-over")}handle_drop(e){e.preventDefault();const t=e.target;if(t.classList.remove("drag-over"),e.dataTransfer!==null){const n=e.dataTransfer.getData("text/plain"),i=t.dataset.targetBoneName;n!==""&&i!==void 0&&(this.bone_mapping.set(i,n),console.log(`Mapped: ${i} <- ${n}`),this.update_target_bones_list(),this.update_clear_button_visibility(),this.dispatchEvent(new CustomEvent("bone-mapping-updated",{detail:{target_bone:i,source_bone:n}})),this.dispatchEvent(new CustomEvent("bone-mappings-changed")))}}get_bone_mapping(){return new Map(this.bone_mapping)}has_bone_mappings(){return this.bone_mapping.size>0}update_clear_button_visibility(){this.clear_mappings_button!==null&&(this.clear_mappings_button.style.display=this.has_bone_mappings()?"block":"none")}update_auto_map_button_visibility(){this.auto_map_button!==null&&(this.auto_map_button.style.display=this.has_both_skeletons()?"block":"none")}clear_bone_mapping(e){this.bone_mapping.delete(e),this.update_target_bones_list(),this.update_clear_button_visibility(),this.dispatchEvent(new CustomEvent("bone-mappings-changed"))}clear_all_bone_mappings(){this.bone_mapping.clear(),this.update_target_bones_list(),this.update_clear_button_visibility(),this.dispatchEvent(new CustomEvent("bone-mappings-changed"))}auto_map_bones(){if(this.bone_mapping.clear(),!this.has_both_skeletons()){console.warn("Cannot auto-map: both source and target skeletons are required");return}E.is_target_valid_skeleton(this.get_target_bone_names())?this.target_mapping_template="mixamo":this.target_mapping_template="custom";const e=Q.auto_map_bones(this.source_armature,this.target_skeleton_data,this.target_mapping_template);this.bone_mapping=e,console.log(`Auto-mapped ${e.size} bones:`,e),this.update_target_bones_list(),this.update_clear_button_visibility(),this.dispatchEvent(new CustomEvent("bone-mappings-changed"))}}class F{static retarget_animation_clip(e,t,n,i=null,a=null,s=[]){const o=[];e.tracks.forEach(m=>{const _=this.parse_track_name_for_metadata(m.name);if(_===null)return;const p=this.reverse_bone_mapping(t).get(_.bone_name);p===void 0||p.length===0||p.forEach(h=>{const l=w.create_track_name(h,_.property);if(_.property==="quaternion"){const k=new C(l,m.times.slice(),m.values.slice());o.push(k)}else if(_.property==="position"||_.property==="scale"){const k=new T(l,m.times.slice(),m.values.slice());o.push(k)}else console.warn("This track contains unsupported property for retargeting:",_.property)})});const r=new I(`${e.name}`,e.duration,o);return n===L.Mixamo&&this.apply_bone_rotation_correction(r,t,i,a,s),console.log(`Retargeted animation: ${e.name} (${o.length} tracks)`),r}static reverse_bone_mapping(e){const t=new Map;return e.forEach((n,i)=>{t.has(n)||t.set(n,[]);const a=t.get(n);a!==void 0&&a.push(i)}),t}static apply_bone_rotation_correction(e,t,n,i,a){t.forEach((s,o)=>{const r=this.calculate_bone_rotation_delta(s,o,n,i,a);if(r!==null){const m=new N().setFromQuaternion(r);this.rotate_bone_for_retargeting(e,[o],m)}else console.log(`Warning: delta is NULL when fixing bone roll. Skipping correction for bone: ${o}`)}),console.log("Applied Mixamo-specific corrections to retargeted animation (dynamically calculated)",e)}static calculate_bone_rotation_delta(e,t,n,i,a){if(n===null||i===null)return console.warn("Cannot calculate rotation delta: missing skeleton data"),null;const s=this.find_bone_by_name(n,[],e),o=this.find_bone_by_name(i,a,t);if(s===null||o===null){const S=s===null?"null":s.name,A=o===null?"null":o.name;return console.debug(`Cannot calculate rotation delta: bone not found (source: ${e}=${S}, target: ${t}=${A})`),null}const r=new b().copy(s.quaternion),_=new b().copy(o.quaternion).clone().invert().multiply(r),p=new g(0,1,0),h=new g(_.x,_.y,_.z),l=p.clone().multiplyScalar(h.dot(p));return new b(l.x,l.y,l.z,_.w).normalize()}static rotate_bone_for_retargeting(e,t,n){const i=e.tracks.filter(s=>t.some(o=>s.name.toLowerCase().includes(o.toLowerCase()))&&s.name.includes("quaternion"));if(i.length===0)return;const a=new b().setFromEuler(n);for(const s of i){if(this.parse_track_name_for_metadata(s.name)===null)continue;const r=s.values;for(let m=0;m<r.length;m+=4){const _=new b(r[m],r[m+1],r[m+2],r[m+3]);_.multiply(a),r[m]=_.x,r[m+1]=_.y,r[m+2]=_.z,r[m+3]=_.w}}}static find_bone_by_name(e,t,n){let i=null;return e.traverse(a=>{i===null&&a.name===n&&(i=a)}),i!==null||t.forEach(a=>{if(i!==null)return;const s=a.skeleton?.bones.find(o=>o.name===n);s!==void 0&&(i=s)}),i}static parse_track_name_for_metadata(e){const t=e.match(/^([^.]+)\.(.+)$/);if(t!==null)return{bone_name:t[1],property:t[2]};const n=e.match(/\.bones\[([^\]]+)\]\.(.+)$/);return n!==null?{bone_name:n[1],property:n[2]}:null}}class V extends EventTarget{constructor(e,t){super(),this.gltf_loader=new D,this.animation_mixer=null,this.current_animation_clip=null,this.retargeted_animation_clip=null,this.target_skinned_meshes=[],this.is_preview_active=!1,this.has_added_event_listeners=!1,this._main_scene=e,this.step_bone_mapping=t}begin(){this.has_added_event_listeners||(this.add_event_listeners(),this.has_added_event_listeners=!0)}add_event_listeners(){this.step_bone_mapping.addEventListener("bone-mappings-changed",()=>{console.log("Bone mappings changed, updating preview animation..."),this.update_preview_animation()}),this.setup_animation_loop()}async start_preview(){if(this.is_preview_active=!0,this.retargeted_animation_clip!==null){this.play_default_animation();return}if(!this.step_bone_mapping.has_both_skeletons()){console.log("Cannot start preview: both skeletons are required");return}const e=this.step_bone_mapping.get_target_skeleton_data();if(e===null){console.log("Cannot start preview: target skeleton data is null");return}if(this.target_skinned_meshes=[],e.traverse(t=>{t.type==="SkinnedMesh"&&this.target_skinned_meshes.push(t)}),this.target_skinned_meshes.length===0){console.log("Cannot start preview: no skinned meshes found in target");return}this.animation_mixer=new y(new x),await this.load_first_animation(),console.log("Preview started successfully")}stop_preview(){this.animation_mixer!==null&&(this.animation_mixer.stopAllAction(),this.animation_mixer=null),this.current_animation_clip=null,this.retargeted_animation_clip=null,this.is_preview_active=!1,console.log("Preview stopped")}async load_first_animation(){const e=this.step_bone_mapping.get_source_skeleton_type(),t=w.get_animation_file_path(e);if(t===null){console.log("No animation file found for skeleton type:",e);return}this.current_animation_clip;try{await new Promise((n,i)=>{this.gltf_loader.load(t,a=>{if(a.animations!==null&&a.animations!==void 0&&a.animations.length>0){const s=a.animations.find(o=>o.name.toLowerCase().includes("walk"));this.current_animation_clip=s??a.animations[0],this.current_animation_clip!==null&&(console.log("Loaded animation:",this.current_animation_clip.name),P.clean_track_data([this.current_animation_clip])),this.update_preview_animation(),n()}else i(new Error("No animations found in file"))},void 0,a=>{i(a)})})}catch(n){console.error("Error loading animation:",n)}}update_preview_animation(){if(!this.is_preview_active||this.current_animation_clip===null||this.animation_mixer===null)return;this.animation_mixer.stopAllAction();const e=this.step_bone_mapping.get_bone_mapping();if(e.size===0){console.log("No bone mappings yet, skipping animation retarget");return}this.retargeted_animation_clip=F.retarget_animation_clip(this.current_animation_clip,e,this.step_bone_mapping.get_target_mapping_template(),this.step_bone_mapping.get_source_armature(),this.step_bone_mapping.get_target_skeleton_data(),this.target_skinned_meshes),this.play_default_animation()}play_default_animation(){if(this.retargeted_animation_clip===null){console.error("retargeting animation clip is null while playing default animation.");return}if(this.animation_mixer===null){console.error("Animation mixer is null while playing default animation.");return}this.target_skinned_meshes.forEach(e=>{const t=this.animation_mixer.clipAction(this.retargeted_animation_clip,e);t.reset(),t.play()})}setup_animation_loop(){let e=performance.now();const t=()=>{requestAnimationFrame(t);const n=performance.now(),i=(n-e)/1e3;e=n,this.is_preview_active&&this.animation_frame_logic(i)};t()}animation_frame_logic(e){this.animation_mixer!==null&&(this.animation_mixer.update(e),this.target_skinned_meshes.forEach(t=>{t.skeleton.bones.forEach(n=>{n.updateMatrixWorld(!0)})}))}}class K extends EventTarget{constructor(){super(...arguments),this.animation_clips_to_export=[],this.bone_mapping=new Map,this.target_mapping_type=L.None,this.source_armature=null,this.target_skeleton_data=null,this.target_skinned_meshes=[],this.target_rig_scene=null}setup_retargeting(e,t,n,i,a,s){this.bone_mapping=n,this.target_mapping_type=i,this.source_armature=a,this.target_skeleton_data=s,this.target_skinned_meshes=t,this.target_rig_scene=e}set_animation_clips_to_export(e,t){this.animation_clips_to_export=[],t.forEach(n=>{const a=e[n].clone();this.animation_clips_to_export.push(a)})}export(e="exported_model"){if(this.animation_clips_to_export.length===0){console.log("ERROR: No animation clips added to export");return}if(this.target_rig_scene==null){console.log("ERROR: target rig scene is null, cannot export");return}let t=[];t=this.animation_clips_to_export.map(n=>F.retarget_animation_clip(n,this.bone_mapping,this.target_mapping_type,this.source_armature,this.target_skeleton_data,this.target_skinned_meshes)),console.log("Retargeted animation clips:",t),this.export_glb(this.target_rig_scene,t,e).then(()=>{console.log("Exported GLB successfully")}).catch(n=>{console.log("Error exporting GLB:",n)})}async export_glb(e,t,n){await new Promise((i,a)=>{const s=new $,o={binary:!0,onlyVisible:!1,embedImages:!0,animations:t};s.parse(e,r=>{r!==null?(this.save_array_buffer(r,`${n}.glb`),i()):(console.log("ERROR: result is not an instance of ArrayBuffer"),a(new Error("Export result is not an ArrayBuffer")))},r=>{console.log("An error happened during parsing",r),a(r)},o)})}save_file(e,t){const n=document.querySelector("#download-hidden-link");n!=null?(n.href=URL.createObjectURL(e),n.download=t,n.click()):console.log("ERROR: dom_export_button_hidden_link is null")}save_array_buffer(e,t){this.save_file(new Blob([e],{type:"application/octet-stream"}),t)}}class X extends EventTarget{constructor(e,t){super(),this.animation_loader=new O,this.step_export_retargeted_animations=new K,this.animation_clips_loaded=[],this.animation_mixer=new y(new x),this.skinned_meshes_to_animate=[],this.skeleton_type=d.Human,this._added_event_listeners=!1,this.animation_search=null,this.is_animations_active=!1,this.target_rig_scene=null,this.export_button=null,this.theme_manager=e,this.animation_player=new q,this.step_bone_mapping=t}begin(e){this.skeleton_type=e,this.reset_step_data(),this._added_event_listeners||(this.add_event_listeners(),this._added_event_listeners=!0)}reset_step_data(){this.animation_clips_loaded=[],this.skinned_meshes_to_animate=[],this.animation_mixer=new y(new x),this.animation_player.clear_animation()}mixer(){return this.animation_mixer}animation_clips(){return this.animation_clips_loaded.map(e=>e.display_animation_clip)}start_preview(){this.is_animations_active=!0}stop_preview(){this.is_animations_active=!1}load_and_apply_default_animation_to_skinned_mesh(e){this.target_rig_scene=e;const t=[];e.traverse(n=>{n.isSkinnedMesh&&t.push(n)}),this.skinned_meshes_to_animate=t,console.log(`Preparing to load animations for ${this.skinned_meshes_to_animate.length} skinned meshes`),this.animation_loader.set_animations_file_path(f("animations/")),this.animation_clips_loaded=[],this.animation_mixer=new y(new x),this.animation_loader.load_animations(this.skeleton_type).then(n=>{this.animation_clips_loaded=n,this.on_all_animations_loaded()}).catch(n=>{console.error("Failed to load animations for retargeting:",n)})}update_export_button_enabled_state(){const e=this.animation_search?.get_selected_animation_indices().length??0;this.export_button!==null&&(this.export_button.disabled=e===0);const t=document.getElementById("animation-selection-count");t!==null&&(t.textContent=e.toString())}on_all_animations_loaded(){this.animation_clips_loaded.sort((t,n)=>t.display_animation_clip.name<n.display_animation_clip.name?-1:t.display_animation_clip.name>n.display_animation_clip.name?1:0),this.build_animation_clip_ui(this.animation_clips_loaded.map(t=>t.display_animation_clip)),this.animation_search?.addEventListener("export-options-changed",()=>{this.update_export_button_enabled_state()});const e=document.getElementById("animation-listing-count");e!==null&&(e.textContent=this.animation_clips_loaded.length.toString()),this.update_export_button_enabled_state(),console.log(`Loaded ${this.animation_clips_loaded.length} animations for retargeting`)}build_animation_clip_ui(e){this.animation_search=new U("animation-filter","animations-items",this.theme_manager,this.skeleton_type),this.animation_search.initialize_animations(e);const t=document.getElementById("animations-items");t!==null&&t.addEventListener("click",n=>{const a=n.target.closest(".play");if(a!==null){const s=parseInt(a.dataset.index??"-1");s>=0&&this.play_animation(s)}})}play_animation(e){if(e<0||e>=this.animation_clips_loaded.length){console.warn("Invalid animation index:",e);return}const n=this.animation_clips_loaded[e].display_animation_clip;this.animation_mixer.stopAllAction();const i=this.step_bone_mapping.get_bone_mapping();if(i.size===0){console.warn("No bone mappings available. Cannot play retargeted animation.");return}const a=F.retarget_animation_clip(n,i,this.step_bone_mapping.get_target_mapping_template(),this.step_bone_mapping.get_source_armature(),this.step_bone_mapping.get_target_skeleton_data(),this.skinned_meshes_to_animate),s=this.skinned_meshes_to_animate.map(o=>{const r=this.animation_mixer.clipAction(a,o);return r.reset(),r.play(),r});this.animation_player.set_animation(a,s),console.log("Playing retargeted animation:",a.name)}add_event_listeners(){this.setup_animation_loop(),this.export_button=document.getElementById("export-retargeting-button"),this.export_button?.addEventListener("click",()=>{this.step_export_retargeted_animations.set_animation_clips_to_export(this.animation_clips_loaded.map(e=>e.display_animation_clip),this.get_selected_animation_indices()),this.step_export_retargeted_animations.setup_retargeting(this.target_rig_scene,this.skinned_meshes_to_animate,this.step_bone_mapping.get_bone_mapping(),this.step_bone_mapping.get_target_mapping_template(),this.step_bone_mapping.get_source_armature(),this.step_bone_mapping.get_target_skeleton_data()),this.step_export_retargeted_animations.export("retargeted_animations")})}get_animation_player(){return this.animation_player}get_selected_animation_indices(){return this.animation_search?.get_selected_animation_indices()??[]}setup_animation_loop(){let e=performance.now();const t=()=>{requestAnimationFrame(t);const n=performance.now(),i=(n-e)/1e3;e=n,this.is_animations_active&&this.animation_frame_logic(i)};t()}animation_frame_logic(e){this.animation_mixer!==null&&(this.animation_mixer.update(e),this.animation_player.update(e),this.skinned_meshes_to_animate.forEach(t=>{t.skeleton.bones.forEach(n=>{n.updateMatrixWorld(!0)})}))}}class Z{constructor(){this.animation_listing_step=null,this.back_to_bone_map_button=null,this.mesh2motion_engine=new W;const e=new g().set(0,1.7,5);this.mesh2motion_engine.set_camera_position(e),this.mesh2motion_engine.set_zoom_limits(.1,1e3),this.step_load_source_skeleton=new j(this.mesh2motion_engine.get_scene()),this.step_load_target_model=new G(this.mesh2motion_engine),this.step_bone_mapping=new z(this.mesh2motion_engine.get_scene()),this.retarget_animation_preview=new V(this.mesh2motion_engine.get_scene(),this.step_bone_mapping)}init(){this.add_event_listeners(),this.step_load_source_skeleton.begin(),this.step_load_target_model.begin(),this.step_bone_mapping.begin(),this.retarget_animation_preview.begin()}add_event_listeners(){this.back_to_bone_map_button=document.getElementById("back_to_bone_map_button");const e=document.getElementById("bone-mapping-step"),t=document.getElementById("skinned-step-animation-export-options"),n=document.getElementById("continue-to-listing-button");this.back_to_bone_map_button.onclick=()=>{e!==null&&t!==null&&(t.style.display="none",e.style.display="inline"),this.step_load_source_skeleton.show_skeleton_helper(!0),this.animation_listing_step!==null&&this.animation_listing_step.stop_preview(),this.start_live_preview(),this.mesh2motion_engine.show_animation_player(!1)},this.step_load_source_skeleton.addEventListener("skeleton-loaded",()=>{const i=this.step_load_source_skeleton.get_loaded_source_armature(),a=this.step_load_source_skeleton.get_skeleton_type();this.step_bone_mapping.set_source_skeleton_data(i,a)}),this.step_load_target_model.addEventListener("target-model-loaded",i=>{const a=this.step_load_target_model.get_retargetable_meshes();this.step_bone_mapping.set_target_skeleton_data(a),this.start_live_preview(),n.style.display="block"}),n.onclick=()=>{e!==null&&t!==null&&(e.style.display="none",t.style.display="inline"),this.step_load_source_skeleton.show_skeleton_helper(!1),this.retarget_animation_preview.stop_preview(),this.animation_listing_step=new X(this.mesh2motion_engine.get_theme_manager(),this.step_bone_mapping),this.animation_listing_step.begin(this.step_load_source_skeleton.get_skeleton_type()),this.mesh2motion_engine.show_animation_player(!0);const i=this.step_load_target_model.get_retargetable_meshes();i!==null?(this.animation_listing_step.load_and_apply_default_animation_to_skinned_mesh(i),this.animation_listing_step.start_preview()):console.error("Retargetable meshes are null while processing click button.")}}start_live_preview(){this.step_bone_mapping.has_both_skeletons()&&(console.log("Both skeletons loaded, starting animation preview..."),this.retarget_animation_preview.start_preview().catch(e=>{console.error("Failed to start preview:",e)}))}}document.addEventListener("DOMContentLoaded",()=>{J.init()});const J=new Z;
